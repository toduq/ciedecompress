# ciede-compress

CIEDE2000という色差式を用いて、画像のピクセルのうち人間が識別できないもの同系色に塗りつぶすことによって、
後続の圧縮の効率を向上させることを目的としたフィルタ。
不可逆変換であり、このフィルタ自身が圧縮を行うわけではない。


## CIEDE2000とは
人間の視覚のうち色の変化を感じ取る能力は、色相や彩度などに依存して変化するため、
これらを考慮することでより劣化を感じさせないまま、不要な情報を削除する。
たとえば、人間は黄色に比べて緑色の色相の変化を感じにくい。
この色相や彩度の依存性を定式化したものがCIEDE2000である。

http://www.konicaminolta.jp/instruments/knowledge/color/part5/02.html


## 実装について

### CIEDE2000の計算

CIEDE2000の計算式についてはWikipediaにて確認することができる。
https://en.wikipedia.org/wiki/Color_difference#CIEDE2000

また、実装の正しさの検証のための参考値が以下の論文から確認できる。
http://www.ece.rochester.edu/~gsharma/ciede2000/ciede2000noteCRNA.pdf

元となる画像の色はRGBであるため、これをXYZ形式、L*a*b*形式に変換したうえで計算する。

この処理が、`color/color.go` に含まれている。

### ピクセルの塗りつぶし

ピクセルを特定の大きさ(デフォルトでは8ピクセル)の正方形に切り取り、これをチャンクと呼ぶ。
このチャンクについて相互に⊿Eを計算する。
特定のしきい値(デフォルトでは1.0)を下回るものについてピックアップし、
最も他のピクセルとの重複の多いピクセルの色で、対応するピクセルを塗りつぶす。
そしてピックアップしたリストから、今塗りつぶしたピクセルを全て除外した後、
再び、最も他のピクセルとの重複の多いピクセルを探し、同じ処理を繰り返す。
しきい値を下回るピクセルの組がなくなった時点で、このチャンクに対する操作を終了し、
次のチャンクを取り出し、同様の操作を行う。

この処理が、 `main.go` に含まれている。

## 検証

`ciedecompress -i src.bmp -o dest8_2.png -size 8 -border 2.0`
というコマンドにおいて、sizeとborderを複数の値で実行し、出来上がったファイルの容量を取得する。

`src`が変換元ファイルであり、`dest(size)_(border)`が変換後である。

また画質についての劣化度について、目視で○△×により評価した。

|               |s = 8 |s = 16|s = 32|
|--------------:|:----:|:----:|:----:|
|b = 0.0(無変換) |753KB○|753KB○|753KB○|
|b = 1.0        |708KB○|711KB○|718KB○|
|b = 2.0        |631KB△|634KB△|645KB△|
|b = 5.0        |493KB×|486KB×|493KB×|
|b = 10.0       |389KB×|375KB×|380KB×|

borderが1.0より大きい領域に置いて、画質が激しく劣化することがわかった。
またsizeを大きくしても圧縮効率は上がらずに、実行時間のみが伸びてしまった。

PNGにおいては、6%程度容量を削減することが出来た。

次にJPG形式であるが、
別の画像において、size=8, border=1.0で変換を行ったところ、
border=0.0(無変換)に比べて、0.5%しか容量が削減されなかった。

## 考察

PNGは可逆圧縮であるので、ピクセルを同じ色で塗りつぶすという古典的な方法でも容量の圧縮が可能であったが、  
JPGは不可逆圧縮であり、JPG自体でもsize=8で似たような圧縮を行っていることから、あまり変化が見られなかったと考える。
